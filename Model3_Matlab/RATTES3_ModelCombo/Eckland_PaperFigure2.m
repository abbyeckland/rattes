function [fignum] = Eckland_PaperFigure2(data5all,calc5all,fignum)

%% Eckland et al. figures
data = data5all;
calc = calc5all;

mask_rattes = (data.inMLR == 1 | (data.issite == 1 & data.PermStorag == 1));
rattes = find(mask_rattes);

%% Figure 2 set up
t1900 = find(calc.t == 1900);
numt  = numel(calc.t);

tfig1 = calc.t(t1900:numt);
nt    = numel(tfig1);

capup = zeros(nt,1);
caplo = zeros(nt,1);
cap   = zeros(nt,1);
sedup = zeros(nt,1);
sedlo = zeros(nt,1);
sed   = zeros(nt,1);
design   = zeros(nt,1);

for i = 1:nt
    n = i + t1900 - 1;
    capup(i) = sum(calc.capup(rattes,n))/1e9;
    caplo(i) = sum(calc.caplo(rattes,n))/1e9;
    cap(i)   = sum(calc.cap(rattes,n))/1e9;

    sedup(i) = sum(calc.sedup(rattes,n))/1e9;
    sedlo(i) = sum(calc.sedlo(rattes,n))/1e9;
    sed(i)   = sum(calc.sed(rattes,n))/1e9;

    design(i)=sum(calc.capdesign(rattes,n))/1e9;
end



%% Create figure 2
figure(fignum);
clf

set(gcf,'Color',[1 1 1], ...
        'OuterPosition',[1410.3333 659.6667 380.6667 389.3333]);
ax = axes;
hold(ax,'on')

% Create water capacity patch
XData1 = [tfig1(:); flipud(tfig1(:))];
YData1 = [capup(:); flipud(caplo(:))];
YData2=  [sedup(:); flipud(sedlo(:))];
Ylines = [design(:), cap(:), sed(:)];


patch('Parent',ax, ...
      'XData', XData1, ...
      'YData', YData1, ...
      'FaceAlpha', 0.3, ...
      'FaceColor', [0.254901960784314 0.411764705882353 0.882352941176471], ...
      'EdgeColor', 'none');

axis tight

% Create sediment patch
patch('Parent',ax, ...
      'XData', XData1, ...
      'YData', YData2, ...
      'FaceAlpha', 0.3, ...
      'FaceColor', [0.823529411764706 0.705882352941177 0.549019607843137], ...
      'EdgeColor', 'none');

% Create multiple line objects using matrix input to plot
plotLines = plot(ax, tfig1, Ylines, ...
    'LineWidth',1.5, ...
    'LineStyle','--');

set(plotLines(1), ...
    'DisplayName','Design capacity', ...
    'Color',[0 0 0], ...
    'LineStyle','-');

set(plotLines(2), ...
    'DisplayName','Model result', ...
    'Color',[0 0 0.5]);

set(plotLines(3), ...
    'Color',[0.5451 0.2706 0.0745]);   % no DisplayName


% --- Dummy legend objects (not plotted in data space) ---
hDesign = plot(nan, nan, ...
    'LineStyle','-', ...
    'LineWidth',1.5, ...
    'Color',[0 0 0]);

hModel = plot(nan, nan, ...
    'LineStyle','--', ...
    'LineWidth',1.5, ...
    'Color',[0 0 0]);

hConf = patch(nan, nan, [0.7 0.7 0.7], ...
    'FaceAlpha',0.3, ...
    'EdgeColor','none');

% --- Legend ---
leg = legend([hDesign hModel hConf], ...
    {'Design capacity','Model result','95% confidence'}, ...
    'Location','northwest');

set(leg, ...
    'IconColumnWidth',6, ...
    'Color',[1 1 1], ...
    'EdgeColor',[0 0 0], ...
    'FontName','Arial', ...
    'FontSize',8, ...
    'Box','on');

% Create ylabel
ylabel('Volume of Water or Sediment, km^3','FontName','Arial','FontSize',10);

% Create xlabel
xlabel('Year','FontName','Arial','FontSize',10);

set(ax,'Color',[0.95 0.95 0.95]);
xlim(ax,[1900 2050]);
ylim(ax,[0 850]);
box(ax,'on');
hold(ax,'off');

% Create textbox
annotation(gcf,'textbox',...
    [0.703911482243289 0.206646240461822 0.221311475409836 0.0838852097130243],...
    'Color',[0.509803921568627 0.411764705882353 0.188235294117647],...
    'String','sediment',...
    'FontWeight','bold',...
    'FontName','Arial',...
    'EdgeColor','none');

% Create textbox
annotation(gcf,'textbox',...
    [0.622711045011382 0.755 0.312386156648452 0.0838852097130243],...
    'Color',[0.0392156862745098 0.266666666666667 0.419607843137255],...
    'String',{'water capacity'},...
    'FontWeight','bold',...
    'FontName','Arial',...
    'EdgeColor','none');

savefig(gcf,'Figure2Eckland.fig');
fignum=fignum+1;
end
